#!/bin/sh

###########################################################################################################################################################

# HotPi Pro - Mobile Hotspot & Media Server +Emulation Station (SIMCom SIM7600/Quectel EC25 - Qualcomm MSM Interface)

###########################################################################################################################################################

# INITIALIZATION

echo "
HotPi Pro is being installed on your system...
"
sleep 1

###########################################################################################################################################################

# SOFTWARE UPDATES

apt update && sudo apt upgrade -y
apt install bridge-utils dnsmasq hostapd ifupdown iptables libqmi-utils pix-plym-splash plymouth plymouth-themes resolvconf samba udhcpc udiskie udisks2 xrdp -y
wget https://raw.githubusercontent.com/gbrideau/scripts/main/hotpipro.png -O /usr/share/plymouth/themes/pix/splash.png

###########################################################################################################################################################

# NETWORK SETTINGS

	# Network Bridge

		# Gateway Node

sed -i -e /allow-hotplug\ br0/d -e /iface\ br0\ inet\ static/d -e /address\ 192.168.0.1/d -e /bridge_ports\ wlan0\ eth0/d /etc/network/interfaces
echo 'allow-hotplug br0
iface br0 inet static
address 192.168.0.1
bridge_ports wlan0 eth0' >> /etc/network/interfaces

		# DHCP Server

sed -i -e /interface=br0/d -e /dhcp-range=192.168.0.2,192.168.0.254,24h/d /etc/dnsmasq.conf
echo 'interface=br0
dhcp-range=192.168.0.2,192.168.0.254,24h' >> /etc/dnsmasq.conf

		# Packet Forwarding

sed -i /^net.ipv4.ip_forward=1/d /etc/sysctl.conf
echo net.ipv4.ip_forward=1 >> /etc/sysctl.conf

		# Packet Filtering

iptables -t nat -F
iptables -t nat -A POSTROUTING -o wwan0 -j MASQUERADE
iptables-save > /etc/hotpitables

	# Wi-Fi Network

echo 'interface=wlan0
bridge=br0
ieee80211ac=1
channel=36
hw_mode=a
ht_capab=[HT40+]
wmm_enabled=1
wpa=2
wpa_key_mgmt=WPA-PSK
rsn_pairwise=CCMP' > /etc/hostapd/hostapd.conf

	# Network-Attached Storage

echo 'sudo sed -i -e '"'"'/\[BIOS]/,$d'"'"' -e '"'"'/\[RetroPie]/,$d'"'"' /etc/samba/smb.conf
sudo sh -c "echo '"'"'[RetroPie]
path = /home/RetroPie
public = yes
writeable = yes
[USB Storage]
path = /media/$USER
public = yes
writeable = yes'"'"' >> /etc/samba/smb.conf"
sudo mkdir -p /home/RetroPie /media/$USER
sudo chmod -R 777 /home/RetroPie /media/$USER' > /etc/profile.d/hotpisamba.sh

###########################################################################################################################################################

# MEDIA SETTINGS

	# Splash Screen

sed -i -e s/\ plymouth.ignore-serial-consoles// -e s/\ splash// /boot/firmware/cmdline.txt
sed -i s/$/\ plymouth.ignore-serial-consoles\ splash/ /boot/firmware/cmdline.txt
echo '[Unit]
Before=display-manager.service plymouth-quit.service
[Service]
Type=oneshot
ExecStart=sleep 3
[Install]
WantedBy=plymouth-start.service' > /etc/systemd/system/hotpisplash.service

###########################################################################################################################################################

# POWER SETTINGS

	# Power Button

sed -i /dtoverlay=gpio-shutdown,debounce=1000/d /boot/firmware/config.txt
echo dtoverlay=gpio-shutdown,debounce=1000 >> /boot/firmware/config.txt

	# USB Ports

sed -i /usb_max_current_enable=1/d /boot/firmware/config.txt
echo usb_max_current_enable=1 >> /boot/firmware/config.txt

###########################################################################################################################################################

# USER COMMANDS

	# Set Wi-Fi Network Country Code

echo '#!/bin/sh
echo "
Enter your Wi-Fi network country code:
(type \\e[93mlist\\e[0m for a detailed list of available Wi-Fi network country codes)
"
read entry
entry=$(echo $entry | sed '"'s/.*/\U&/'"')
if [ "$entry" = LIST ]
then
echo "
AF (Afghanistan)				PS (Gaza Strip/West Bank)			NO (Norway)
AX (Aland Islands)				GE (Georgia)					OM (Oman)
AL (Albania)					DE (Germany)					PK (Pakistan)
DZ (Algeria)					GH (Ghana)					PW (Palau)
AS (American Samoa)				GI (Gibraltar)					PA (Panama)
AD (Andorra)					GR (Greece)					PG (Papua New Guinea)
AO (Angola)					GL (Greenland)					PY (Paraguay)
AI (Anguilla)					GD (Grenada)					PE (Peru)
AQ (Antarctica)					GP (Guadeloupe)					PH (Philippines)
AG (Antigua and Barbuda)			GU (Guam)					PN (Pitcairn Islands)
AR (Argentina)					GT (Guatemala)					PL (Poland)
AM (Armenia)					GG (Guernsey)					PT (Portugal)
AW (Aruba)					GN (Guinea)					PR (Puerto Rico)
AC (Ascension Island)				GW (Guinea-Bissau)				QA (Qatar)
AU (Australia)					GY (Guyana)					CG (Republic of the Congo)
AT (Austria)					HT (Haiti)					RE (Reunion)
AZ (Azerbaijan)					HM (Heard Island and McDonald Islands)		RO (Romania)
BH (Bahrain)					VA (Holy See (Vatican City))			RU (Russia)
BD (Bangladesh)					HN (Honduras)					RW (Rwanda)
BB (Barbados)					HK (Hong Kong)					BL (Saint Barthelemy)
BY (Belarus)					HU (Hungary)					SH (Saint Helena, Ascension, and Tristan da Cunha)
BE (Belgium)					IS (Iceland)					KN (Saint Kitts and Nevis)
BZ (Belize)					IN (India)					LC (Saint Lucia)
BJ (Benin)					ID (Indonesia)					MF (Saint Martin)
BM (Bermuda)					IR (Iran)					PM (Saint Pierre and Miquelon)
BT (Bhutan)					IQ (Iraq)					VC (Saint Vincent and the Grenadines)
BO (Bolivia)					IE (Ireland)					WS (Samoa)
BA (Bosnia and Herzegovina)			IM (Isle of Man)				SM (San Marino)
BW (Botswana)					IL (Israel)					ST (Sao Tome and Principe)
BV (Bouvet Island)				IT (Italy)					SA (Saudi Arabia)
BR (Brazil)					JM (Jamaica)					SN (Senegal)
IO (British Indian Ocean Territory)		JP (Japan)					RS (Serbia)
VG (British Virgin Islands			JE (Jersey)					SC (Seychelles)
BN (Brunei)					JO (Jordan)					SL (Sierra Leone)
BG (Bulgaria)					KZ (Kazakhstan)					SG (Singapore)
BF (Burkina Faso)				KE (Kenya)					SX (Sint Maarten)
MM (Burma)					KI (Kiribati)					SK (Slovakia)
BI (Burundi)					XK (Kosovo)					SI (Slovenia)
CV (Cabo Verde)					KW (Kuwait)					SB (Solomon Islands)
KH (Cambodia)					KG (Kyrgyzstan)					SO (Somalia)
CM (Cameroon)					LA (Laos)					ZA (South Africa)
CA (Canada)					LV (Latvia)					KR (South Korea)
KY (Cayman Islands)				LB (Lebanon)					SS (South Sudan)
CF (Central African Republic)			LS (Lesotho)					SU (Soviet Union)
TD (Chad)					LR (Liberia)					ES (Spain)
CL (Chile)					LY (Libya)					LK (Sri Lanka)
CN (China)					LI (Liechtenstein)				SD (Sudan)
CX (Christmas Island)				LT (Lithuania)					SR (Suriname)
CC (Cocos (Keeling) Islands)			LU (Luxembourg)					SJ (Svalbard)
CO (Colombia)					MO (Macau)					SE (Sweden)
KM (Comoros)					MG (Madagascar)					CH (Switzerland)
CK (Cook Islands)				MW (Malawi)					SY (Syria)
CR (Costa Rica)					MY (Malaysia)					TW (Taiwan)
CI (Cote d'"'"'Ivoire)				MV (Maldives)					TJ (Tajikistan)
HR (Croatia)					ML (Mali)					TZ (Tanzania)
CU (Cuba)					MT (Malta)					TH (Thailand)
CW (Curacao)					MH (Marshall Islands)				BS (The Bahamas)
CY (Cyprus)					MQ (Martinique)					GM (The Gambia)
CZ (Czechia)					MR (Mauritania)					TL (Timor-Leste)
CD (Democratic Republic of the Congo)		MU (Mauritius)					TG (Togo)
DK (Denmark)					YT (Mayotte)					TK (Tokelau)
DJ (Djibouti)					MX (Mexico)					TO (Tonga)
DM (Dominica)					MD (Moldova)					TT (Trinidad and Tobago)
DO (Dominican Republic)				MC (Monaco)					TN (Tunisia)
EC (Ecuador)					MN (Mongolia)					TR (Turkey (Turkiye))
EG (Egypt)					ME (Montenegro)					TM (Turkmenistan)
SV (El Salvador)				MS (Montserrat)					TC (Turks and Caicos Islands)
GQ (Equatorial Guinea)				MA (Morocco)					TV (Tuvalu)
ER (Eritrea)					MZ (Mozambique)					UG (Uganda)
EE (Estonia)					NA (Namibia)					UA (Ukraine)
SZ (Eswatini)					NR (Nauru)					AE (United Arab Emirates)
ET (Ethiopia)					NP (Nepal)					UK (United Kingdom)
EU (European Union)				NL (Netherlands)				US (United States)
FK (Falkland Islands (Islas Malvinas))		NC (New Caledonia)				UY (Uruguay)
FO (Faroe Islands)				NZ (New Zealand)				UZ (Uzbekistan)
FM (Federated States of Micronesia)		NI (Nicaragua)					VU (Vanuatu)
FJ (Fiji)					NE (Niger)					VE (Venezuela)
FI (Finland)					NG (Nigeria)					VN (Vietnam)
FR (France)					NU (Niue)					VI (Virgin Islands)
GF (French Guiana)				NF (Norfolk Island)				WF (Wallis and Futuna)
PF (French Polynesia)				KP (North Korea)				YE (Yemen)
TF (French Southern and Antarctic Lands)	MK (North Macedonia)				ZM (Zambia)
GA (Gabon)					MP (Northern Mariana Islands)			ZW (Zimbabwe)
"
sleep 1
hotpiwc
exit
elif [ "$entry" = AC -o "$entry" = AD -o "$entry" = AE -o "$entry" = AF -o "$entry" = AG -o "$entry" = AI -o "$entry" = AL -o "$entry" = AM -o "$entry" = AO -o "$entry" = AQ -o "$entry" = AR -o "$entry" = AS -o "$entry" = AT -o "$entry" = AU -o "$entry" = AW -o "$entry" = AX -o "$entry" = AZ -o "$entry" = BA -o "$entry" = BB -o "$entry" = BD -o "$entry" = BE -o "$entry" = BF -o "$entry" = BG -o "$entry" = BH -o "$entry" = BI -o "$entry" = BJ -o "$entry" = BL -o "$entry" = BM -o "$entry" = BN -o "$entry" = BO -o "$entry" = BR -o "$entry" = BS -o "$entry" = BT -o "$entry" = BV -o "$entry" = BW -o "$entry" = BY -o "$entry" = BZ -o "$entry" = CA -o "$entry" = CC -o "$entry" = CD -o "$entry" = CF -o "$entry" = CG -o "$entry" = CH -o "$entry" = CI -o "$entry" = CK -o "$entry" = CL -o "$entry" = CM -o "$entry" = CN -o "$entry" = CO -o "$entry" = CR -o "$entry" = CU -o "$entry" = CV -o "$entry" = CW -o "$entry" = CX -o "$entry" = CY -o "$entry" = CZ -o "$entry" = DE -o "$entry" = DJ -o "$entry" = DK -o "$entry" = DM -o "$entry" = DO -o "$entry" = DZ -o "$entry" = EC -o "$entry" = EE -o "$entry" = EG -o "$entry" = ER -o "$entry" = ES -o "$entry" = ET -o "$entry" = EU -o "$entry" = FI -o "$entry" = FJ -o "$entry" = FK -o "$entry" = FM -o "$entry" = FO -o "$entry" = FR -o "$entry" = GA -o "$entry" = GD -o "$entry" = GE -o "$entry" = GF -o "$entry" = GG -o "$entry" = GH -o "$entry" = GI -o "$entry" = GL -o "$entry" = GM -o "$entry" = GN -o "$entry" = GP -o "$entry" = GQ -o "$entry" = GR -o "$entry" = GT -o "$entry" = GU -o "$entry" = GW -o "$entry" = GY -o "$entry" = HK -o "$entry" = HM -o "$entry" = HN -o "$entry" = HR -o "$entry" = HT -o "$entry" = HU -o "$entry" = ID -o "$entry" = IE -o "$entry" = IL -o "$entry" = IM -o "$entry" = IN -o "$entry" = IO -o "$entry" = IQ -o "$entry" = IR -o "$entry" = IS -o "$entry" = IT -o "$entry" = JE -o "$entry" = JM -o "$entry" = JO -o "$entry" = JP -o "$entry" = KE -o "$entry" = KG -o "$entry" = KH -o "$entry" = KI -o "$entry" = KM -o "$entry" = KN -o "$entry" = KP -o "$entry" = KR -o "$entry" = KW -o "$entry" = KY -o "$entry" = KZ -o "$entry" = LA -o "$entry" = LB -o "$entry" = LC -o "$entry" = LI -o "$entry" = LK -o "$entry" = LR -o "$entry" = LS -o "$entry" = LT -o "$entry" = LU -o "$entry" = LV -o "$entry" = LY -o "$entry" = MA -o "$entry" = MC -o "$entry" = MD -o "$entry" = ME -o "$entry" = MF -o "$entry" = MG -o "$entry" = MH -o "$entry" = MK -o "$entry" = ML -o "$entry" = MM -o "$entry" = MN -o "$entry" = MO -o "$entry" = MP -o "$entry" = MQ -o "$entry" = MR -o "$entry" = MS -o "$entry" = MT -o "$entry" = MU -o "$entry" = MV -o "$entry" = MW -o "$entry" = MX -o "$entry" = MY -o "$entry" = MZ -o "$entry" = NA -o "$entry" = NC -o "$entry" = NE -o "$entry" = NF -o "$entry" = NG -o "$entry" = NI -o "$entry" = NL -o "$entry" = NO -o "$entry" = NP -o "$entry" = NR -o "$entry" = NU -o "$entry" = NZ -o "$entry" = OM -o "$entry" = PA -o "$entry" = PE -o "$entry" = PF -o "$entry" = PG -o "$entry" = PH -o "$entry" = PK -o "$entry" = PL -o "$entry" = PM -o "$entry" = PN -o "$entry" = PR -o "$entry" = PS -o "$entry" = PT -o "$entry" = PW -o "$entry" = PY -o "$entry" = QA -o "$entry" = RE -o "$entry" = RO -o "$entry" = RS -o "$entry" = RU -o "$entry" = RW -o "$entry" = SA -o "$entry" = SB -o "$entry" = SC -o "$entry" = SD -o "$entry" = SE -o "$entry" = SG -o "$entry" = SH -o "$entry" = SI -o "$entry" = SJ -o "$entry" = SK -o "$entry" = SL -o "$entry" = SM -o "$entry" = SN -o "$entry" = SO -o "$entry" = SR -o "$entry" = SS -o "$entry" = ST -o "$entry" = SU -o "$entry" = SV -o "$entry" = SX -o "$entry" = SY -o "$entry" = SZ -o "$entry" = TC -o "$entry" = TD -o "$entry" = TF -o "$entry" = TG -o "$entry" = TH -o "$entry" = TJ -o "$entry" = TK -o "$entry" = TL -o "$entry" = TM -o "$entry" = TN -o "$entry" = TO -o "$entry" = TR -o "$entry" = TT -o "$entry" = TV -o "$entry" = TW -o "$entry" = TZ -o "$entry" = UA -o "$entry" = UG -o "$entry" = UK -o "$entry" = US -o "$entry" = UY -o "$entry" = UZ -o "$entry" = VA -o "$entry" = VC -o "$entry" = VE -o "$entry" = VG -o "$entry" = VI -o "$entry" = VN -o "$entry" = VU -o "$entry" = WF -o "$entry" = WS -o "$entry" = XK -o "$entry" = YE -o "$entry" = YT -o "$entry" = ZA -o "$entry" = ZM -o "$entry" = ZW ]
then
sudo sed -i /country_code=.*/d /etc/hostapd/hostapd.conf
sudo sh -c "echo country_code=$entry >> /etc/hostapd/hostapd.conf"
echo "
Your Wi-Fi network country code has been set to: \\e[36m$entry\\e[0m
"
sleep 1
else
echo "
You have entered an invalid entry...
"
sleep 1
hotpiwc
exit
fi' > /bin/hotpiwc

	# Set Wi-Fi Network Name

echo '#!/bin/sh
echo "
Create your Wi-Fi network name:
(1 to 32 characters)
"
read entry
if [ ${#entry} -lt 1 -o ${#entry} -gt 32 ]
then
echo "
Your Wi-Fi network name must have 1 to 32 characters...
"
sleep 1
hotpiwn
exit
fi
sudo sed -i /ssid=.*/d /etc/hostapd/hostapd.conf
sudo sh -c "echo ssid=$entry >> /etc/hostapd/hostapd.conf"
echo "
Your Wi-Fi network name has been set to: \\e[36m$entry\\e[0m
"
sleep 1' > /bin/hotpiwn

	# Set Wi-Fi Network Password

echo '#!/bin/sh
echo "
Create your Wi-Fi network password:
(8 to 63 characters)
"
read entry
if [ ${#entry} -lt 8 -o ${#entry} -gt 63 ]
then
echo "
Your Wi-Fi network password must have 8 to 63 characters...
"
sleep 1
hotpiwp
exit
fi
sudo sed -i /wpa_passphrase=.*/d /etc/hostapd/hostapd.conf
sudo sh -c "echo wpa_passphrase=$entry >> /etc/hostapd/hostapd.conf"
echo "
Your Wi-Fi network password has been set to: \\e[36m$entry\\e[0m
"
sleep 1' > /bin/hotpiwp

	# Set Composite Video Standard

echo '#!/bin/sh
echo "
Enter your composite video standard:
(NTSC, Japanese NTSC, PAL, Brazilian PAL, Progressive Scan NTSC, Progressive Scan PAL)
"
read entry
entry=$(echo $entry | sed '"'s/.*/\L&/'"')
if [ "$entry" = ntsc ]
then
sudo sed -i /^sdtv_mode=.*/d /boot/config.txt
sudo sh -c "echo sdtv_mode=0 >> /boot/config.txt"
echo "
Your composite video standard has been set to: \\e[36mNTSC\\e[0m
"
elif [ "$entry" = "japanese ntsc" ]
then
sudo sed -i /^sdtv_mode=.*/d /boot/config.txt
sudo sh -c "echo sdtv_mode=1 >> /boot/config.txt"
echo "
Your composite video standard has been set to: \\e[36mJapanese NTSC\\e[0m
"
elif [ "$entry" = pal ]
then
sudo sed -i /^sdtv_mode=.*/d /boot/config.txt
sudo sh -c "echo sdtv_mode=2 >> /boot/config.txt"
echo "
Your composite video standard has been set to: \\e[36mPAL\\e[0m
"
elif [ "$entry" = "brazilian pal" ]
then
sudo sed -i /^sdtv_mode=.*/d /boot/config.txt
sudo sh -c "echo sdtv_mode=3 >> /boot/config.txt"
echo "
Your composite video standard has been set to: \\e[36mBrazilian PAL\\e[0m
"
elif [ "$entry" = "progressive scan ntsc" ]
then
sudo sed -i /^sdtv_mode=.*/d /boot/config.txt
sudo sh -c "echo sdtv_mode=16 >> /boot/config.txt"
echo "
Your composite video standard has been set to: \\e[36mProgressive Scan NTSC\\e[0m
"
elif [ "$entry" = "progressive scan pal" ]
then
sudo sed -i /^sdtv_mode=.*/d /boot/config.txt
sudo sh -c "echo sdtv_mode=18 >> /boot/config.txt"
echo "
Your composite video standard has been set to: \\e[36mProgressive Scan PAL\\e[0m
"
else
echo "
You have entered an invalid entry...
"
sleep 1
hotpics
exit
fi
sleep 1' > /bin/hotpics

	# Set Composite Video Aspect Ratio

echo '#!/bin/sh
echo "
Enter your composite video aspect ratio:
(4:3, 14:9, 16:9)
"
read entry
if [ "$entry" = 4:3 ]
then
sudo sed -i /^sdtv_aspect=.*/d /boot/config.txt
sudo sh -c "echo sdtv_aspect=1 >> /boot/config.txt"
elif [ "$entry" = 14:9 ]
then
sudo sed -i /^sdtv_aspect=.*/d /boot/config.txt
sudo sh -c "echo sdtv_aspect=2 >> /boot/config.txt"
elif [ "$entry" = 16:9 ]
then
sudo sed -i /^sdtv_aspect=.*/d /boot/config.txt
sudo sh -c "echo sdtv_aspect=3 >> /boot/config.txt"
else
echo "
You have entered an invalid entry...
"
sleep 1
hotpicr
exit
fi
echo "
Your composite video aspect ratio has been set to: \\e[36m$entry\\e[0m
"
sleep 1' > /bin/hotpicr

	# Establish Internet Connection

echo '#!/bin/sh
if [ $(wget -q --spider google.com ; echo $?) != 0 ]
then
echo "
Your internet connection is being established...
"
sleep 1
sudo iptables-restore < /etc/hotpitables
sudo qmicli -d /dev/cdc-wdm0 --dms-set-operating-mode=online
sudo qmicli -d /dev/cdc-wdm0 -E raw-ip &&
sudo qmicli -d /dev/cdc-wdm0 -p --wds-start-network=ip-type=4 --client-no-release-cid &&
sudo udhcpc -i wwan0 &&
sleep 1 &&
echo "
Your internet connection has been established.
"
if [ $(wget -q --spider google.com ; echo $?) != 0 ]
then
sleep 1
echo "
Your internet connection could not be established.
"
fi
elif [ $(wget -q --spider google.com ; echo $?) = 0 ]
then
echo "
Your internet connection has already been established...
"
sleep 1
echo "
Would you like to reestablish your internet connection?
(yes/no)
"
read entry
entry=$(echo $entry | sed '"'s/.*/\L&/'"')
if [ "$entry" = yes ]
then
sudo ifconfig wwan0 down
hotpiec
exit
elif [ "$entry" = no ]
then
echo "
Your internet connection has been resumed.
"
else
echo "
You have entered an invalid entry...
"
sleep 0.5
hotpiec
exit
fi
fi' > /bin/hotpiec

	# Terminate Internet Connection

echo '#!/bin/sh
if [ $(wget -q --spider google.com ; echo $?) = 0 ]
then
sudo ifconfig wwan0 down
echo "
Your internet connection has been terminated.
"
elif [ $(wget -q --spider google.com ; echo $?) != 0 ]
then
sudo ifconfig wwan0 down
echo "
Your internet connection has not been established.
"
fi' > /bin/hotpitc

	# Mount USB Storage Device

echo '#!/bin/sh
echo "
Enter your USB storage device name:
(type \\e[93mlist\\e[0m for a detailed list of available USB storage device names)
"
read entry
entry=$(echo $entry | sed '"'s/.*/\L&/'"')
if [ "$entry" = list ]
then
echo
lsblk -o NAME,SIZE,MOUNTPOINT | sed /mmcblk0/d
echo
sleep 1
hotpimd
exit
elif [ $(lsblk -n -o MOUNTPOINT /dev/$entry > /dev/null 2>&1 ; echo $?) = 0 ] && [ -z "$(lsblk -n -o MOUNTPOINT /dev/$entry)" ]
then
echo "
Your USB storage device is being mounted...
"
sleep 1
udisksctl mount -b /dev/$entry
sleep 1
echo "
Your USB storage device has been mounted.
"
sleep 1
elif [ -n "$(lsblk -n -o MOUNTPOINT /dev/$entry 2> /dev/null)" ]
then
echo "
Your USB storage device has already been mounted.
"
sleep 1
else
echo "
You have entered an invalid entry...
"
sleep 1
hotpimd
exit
fi' > /bin/hotpimd

	# Unmount USB Storage Device

echo '#!/bin/sh
echo "
Enter your USB storage device name:
(type \\e[93mlist\\e[0m for a detailed list of available USB storage device names)
"
read entry
entry=$(echo $entry | sed '"'s/.*/\L&/'"')
if [ "$entry" = list ]
then
echo
lsblk -o NAME,SIZE,MOUNTPOINT | sed /mmcblk0/d
echo
sleep 1
hotpiud
exit
elif [ -n "$(lsblk -n -o MOUNTPOINT /dev/$entry 2> /dev/null)" ]
then
echo "
Your USB storage device is being unmounted...
"
sleep 1
udisksctl unmount -b /dev/$entry
sleep 1
echo "
Your USB storage device has been unmounted.
"
sleep 1
elif [ $(lsblk -n -o MOUNTPOINT /dev/$entry > /dev/null 2>&1 ; echo $?) = 0 ] && [ -z "$(lsblk -n -o MOUNTPOINT /dev/$entry)" ]
then
echo "
Your USB storage device has already been unmounted.
"
sleep 1
else
echo "
Your have entered an invalid entry...
"
sleep 1
hotpiud
exit
fi' > /bin/hotpiud

	# Launch Emulation Station

echo '#!/bin/sh
emulationstation' > /bin/hotpiem

	# Reboot Raspberry Pi

echo '#!/bin/sh
sudo reboot' > /bin/hotpirp

	# Shutdown Raspberry Pi

echo '#!/bin/sh
sudo shutdown now' > /bin/hotpisp

	# View User Command List

echo '#!/bin/sh
echo "
COMMAND            DESCRIPTION

\\e[93mhotpiwc\\e[0m            Set Wi-Fi Network Country Code
\\e[93mhotpiwn\\e[0m            Set Wi-Fi Network Name
\\e[93mhotpiwp\\e[0m            Set Wi-Fi Network Password
\\e[93mhotpics\\e[0m            Set Composite Video Standard
\\e[93mhotpicr\\e[0m            Set Composite Video Aspect Ratio
\\e[93mhotpiec\\e[0m            Establish Internet Connection
\\e[93mhotpitc\\e[0m            Terminate Internet Connection
\\e[93mhotpimd\\e[0m            Mount USB Storage Device
\\e[93mhotpiud\\e[0m            Unmount USB Storage Device
\\e[93mhotpiem\\e[0m            Launch Emulation Station
\\e[93mhotpirp\\e[0m            Reboot Raspberry Pi
\\e[93mhotpisp\\e[0m            Shutdown Raspberry Pi
\\e[93mhotpicl\\e[0m            View User Command List
"' > /bin/hotpicl

###########################################################################################################################################################

# USER PERMISSIONS

	# User Commands

chmod -R 777 /bin/hotpi*

	# USB Mounting

sed -i -e 87s/auth_admin/yes/ -e 89s/auth_admin_keep/yes/ /usr/share/polkit-1/actions/org.freedesktop.UDisks2.policy

###########################################################################################################################################################

# AUTOMATION

	# Internet Connection

echo '[Service]
ExecStart=hotpiec' > /etc/systemd/system/hotpistart.service
echo 'ATTR{idVendor}=="1e0e", ATTR{idProduct}=="9001", RUN+="/bin/systemctl start hotpistart"
ATTR{idVendor}=="2c7c", ATTR{idProduct}=="0125", RUN+="/bin/systemctl start hotpistart"' > /etc/udev/rules.d/hotpistart.rules

	# USB Mounting

echo '[Service]
ExecStart=udiskie -N -F' > /etc/systemd/user/hotpimount.service
echo systemctl --user start hotpimount > /etc/profile.d/hotpimount.sh

###########################################################################################################################################################

# EXECUTION

hotpiwc
hotpiwn
hotpiwp
systemctl unmask hostapd
systemctl enable hostapd hotpisplash resolvconf

###########################################################################################################################################################

# FINALIZATION

echo "
HotPi Pro has been installed on your system...
(use \e[93mhotpicl\e[0m for a detailed list of available user commands)
"
sleep 1
echo "
Press ENTER to reboot...
"
read entry
reboot

###########################################################################################################################################################
