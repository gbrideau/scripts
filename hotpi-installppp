#!/bin/sh
sleep 1
echo "\033[;32m"\\nHotPi-PPP will now be installed on your system...
sleep 3
echo \\nPress "\033[;37m"ENTER"\033[;32m" to continue...
read hotpips
apt update
apt upgrade -y
apt install bridge-utils dnsmasq hostapd ppp resolvconf samba xrdp -y
echo \#!/bin/sh\\nsleep 1\\necho '"\\033[;32m"\\\\nEnter your current modem baud rate:\\\\n'\\necho Default: 115200'\\\\n'\\nread hotpibr\\nif '[ $hotpibr = 9600 ] || [ $hotpibr = 19200 ] || [ $hotpibr = 38400 ] || [ $hotpibr = 57600 ] || [ $hotpibr = 115200 ] || [ $hotpibr = 230400 ] || [ $hotpibr = 460800 ] || [ $hotpibr = 921600 ] || [ $hotpibr = 1500000 ] || [ $hotpibr = 2000000 ] || [ $hotpibr = 2500000 ]'\\nthen\\nsleep 1\\necho '\\\\n'Maximizing modem baud rate...\\nsleep 3\\necho '\\\\nModem baud rate set to "\\033[;37m"3000000"\\033[;32m"'...\\nelif '[ $hotpibr = 3000000 ]'\\nthen\\nsleep 1\\necho '\\\\nModem baud rate set to "\\033[;37m"3000000"\\033[;32m"'...\\nelse\\nsleep 1\\necho '\\\\n'Invalid modem baud rate...\\nsleep 2\\nhotpi-setmodem\\nexit\\nfi\\necho '$hotpibr >' /etc/hotpi-baudrate > /bin/hotpi-setmodem
chmod 755 /bin/hotpi-setmodem
hotpi-setmodem
echo \#!/bin/sh\\npppd connect '"'chat "''" atd*99#'"' /dev/ttyAMA0 crtscts 3000000 :10.64.64.64 usepeerdns defaultroute noauth persist updetach > /bin/hotpi-startppp
chmod 755 /bin/hotpi-startppp
echo \#!/bin/sh\\npoff \&\& echo The PPP connection has been stopped. > /bin/hotpi-stopppp
chmod 755 /bin/hotpi-stopppp
sed -i s/console=serial0,115200\ // /boot/cmdline.txt
sed -i /dtoverlay=pi3-disable-bt/d /boot/config.txt
echo dtoverlay=pi3-disable-bt >> /boot/config.txt
echo \#!/bin/sh\\nsleep 3\\necho '\\\\nEnter your Wi-Fi country code:\\\\n'\\necho Canada: CA\\necho United Kingdom: UK\\necho United States: US'\\\\n'\\nread hotpicc\\nsleep 1\\necho '\\\\nWi-Fi country code set to "\\033[;37m"$hotpicc"\\033[;32m"'...\\nsleep 3\\necho '\\\\nCreate your Wi-Fi network name:\\\\n'\\nread hotpinn\\nsleep 1\\necho '\\\\nWi-Fi network name set to "\\033[;37m"$hotpinn"\\033[;32m"'...\\nsleep 3\\necho '\\\\nCreate your Wi-Fi network password:\\\\n'\\nread hotpinp\\nsleep 1\\necho '\\\\nWi-Fi network password set to "\\033[;37m"$hotpinp"\\033[;32m"'...\\nsleep 3\\necho '\\\\nTo change these settings, use the "\\033[;37m"sudo hotpi-setwifi"\\033[;32m"' command...\\nsleep 3\\necho '\\\\nPress "\\033[;37m"ENTER"\\033[;32m"' to continue...\\nread hotpips\\necho \"interface=wlan0\\nbridge=br0\\ncountry_code=\$hotpicc\\nieee80211ac=1\\nwmm_enabled=1\\nhw_mode=a\\nchannel=36\\nht_capab=[HT40+]\\nssid=\$hotpinn\\nwpa_passphrase=\$hotpinp\\nwpa=2\\nwpa_key_mgmt=WPA-PSK\\nrsn_pairwise=CCMP\" \> /etc/hostapd/hostapd.conf > /bin/hotpi-setwifi
chmod 755 /bin/hotpi-setwifi
hotpi-setwifi
sed -i -e /allow-hotplug\ br0/d -e /iface\ br0\ inet\ static/d -e /address\ 192.168.0.1/d -e /bridge_ports\ wlan0\ eth0/d /etc/network/interfaces
echo allow-hotplug br0\\niface br0 inet static\\naddress 192.168.0.1\\nbridge_ports wlan0 eth0 >> /etc/network/interfaces
sed -i -e /interface=br0/d -e /dhcp-range=192.168.0.2,192.168.0.10,24h/d /etc/dnsmasq.conf
echo interface=br0\\ndhcp-range=192.168.0.2,192.168.0.10,24h >> /etc/dnsmasq.conf
sed -i s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/ /etc/sysctl.conf
iptables -t nat -F
iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE
iptables-save > /etc/hotpi-iptables
sed -i -e /\\[External\ Storage]/d -e /path\ =\ \\/media\\/pi/d -e /public\ =\ yes/d -e /writeable\ =\ yes/d /etc/samba/smb.conf
echo [External Storage]\\npath = /media/pi\\npublic = yes\\nwriteable = yes >> /etc/samba/smb.conf
mkdir -p /media/pi
chmod -R 777 /media/pi
echo \#!/bin/sh\\necho \"\\nHotPi-PPP \(GPIO - 3 Mbps\)\\n\\n\\nCommand List:\\n\\n\\nsudo hotpi-help - View command list\\n\\nsudo hotpi-setwifi - Set Wi-Fi settings\\n\\nsudo hotpi-startppp - Start PPP connection\\n\\nsudo hotpi-stopppp - Stop PPP connection\\n\" > /bin/hotpi-help
chmod 755 /bin/hotpi-help
sed -i -e /iptables-restore\ \<\ \\/etc\\/hotpi-iptables/d -e /stty\ -F\ \\/dev\\/ttyAMA0\ 3000000/d -e /hotpi-startppp/d -e s/^exit\ 0/iptables-restore\ \<\ \\/etc\\/hotpi-iptables\\ntail\ -n\ +48\ \\/bin\\/hotpi-installppp\ \|\ sh\\nexit\ 0/ /etc/rc.local
systemctl unmask hostapd
systemctl enable hostapd resolvconf
sleep 1
echo \\nHotPi-PPP has been successfully installed on your system...
sleep 3
echo \\nFor a command list, use the "\033[;37m"sudo hotpi-help"\033[;32m" command...
sleep 3
echo \\nPress "\033[;37m"ENTER"\033[;32m" to reboot...
read hotpips
reboot
stty -F /dev/ttyAMA0 $(cat /etc/hotpi-baudrate)
chat '' at+cgdcont=1,'"ipv4v6"' OK at+iprex=3000000 OK > /dev/ttyAMA0 < /dev/ttyAMA0
stty -F /dev/ttyAMA0 3000000
hotpi-startppp
sed -i s/tail\ -n\ +48\ \\/bin\\/hotpi-installppp\ \|\ sh/stty\ -F\ \\/dev\\/ttyAMA0\ 3000000\\nhotpi-startppp/ /etc/rc.local
