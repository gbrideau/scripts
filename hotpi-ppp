#!/bin/sh
apt update && apt upgrade -y
apt install bridge-utils dnsmasq hostapd ppp resolvconf samba xrdp -y
sed -i s/console=serial0,115200\ // /boot/cmdline.txt
echo dtoverlay=pi3-disable-bt >> /boot/config.txt
echo \#!/bin/sh\\npppd connect '"'chat "''" atd*99#'"' /dev/ttyAMA0 crtscts 3000000 :10.64.64.64 usepeerdns defaultroute noauth persist updetach > /bin/hotpi-startppp
chmod 755 /bin/hotpi-startppp
echo \#!/bin/sh\\npoff \&\& echo The PPP connection has been stopped. > /bin/hotpi-stopppp
chmod 755 /bin/hotpi-stopppp
echo \#!/bin/sh\\necho Enter your Wi-Fi country code '\(US or CA for United States or Canada\)'.\\nread hotpicc\\necho Your Wi-Fi country code has been set to "'"'"'"'"'$hotpicc'"'"'"'"'".\\necho Create your Wi-Fi network name '\(no special characters or spaces\)'.\\nread hotpinn\\necho Your Wi-Fi network name has been set to "'"'"'"'"'$hotpinn'"'"'"'"'".\\necho Create your Wi-Fi network password '\(no special characters or spaces\)'.\\nread hotpinp\\necho Your Wi-Fi network password has been set to "'"'"'"'"'$hotpinp'"'"'"'"'".\\necho Should you wish to change these settings, you can do so using the "'"'"'sudo hotpi-setwifi'"'"'" command in Terminal."\\\\\\\\"nPress ENTER to continue...\\nread hotpips\\necho interface=wlan0'\\\\nbridge=br0\\\\ncountry_code=$hotpicc\\\\nieee80211ac=1\\\\nwmm_enabled=1\\\\nhw_mode=a\\\\nchannel=36\\\\nht_capab=[HT40+]\\\\nssid=$hotpinn\\\\nwpa_passphrase=$hotpinp\\\\nwpa=2\\\\nwpa_key_mgmt=WPA-PSK\\\\nrsn_pairwise=CCMP >' /etc/hostapd/hostapd.conf > /bin/hotpi-setwifi
chmod 755 /bin/hotpi-setwifi
hotpi-setwifi
echo allow-hotplug br0\\niface br0 inet static\\naddress 192.168.0.1\\nbridge_ports wlan0 eth0 >> /etc/network/interfaces
echo interface=br0\\ndhcp-range=192.168.0.2,192.168.0.10,24h >> /etc/dnsmasq.conf
sed -i s/#net.ipv4.ip_forward=1/net.ipv4.ip_forward=1/ /etc/sysctl.conf
iptables -t nat -A POSTROUTING -o ppp0 -j MASQUERADE
iptables-save > /etc/iptables
echo [External Storage]\\npath = /media/pi\\npublic = yes\\nwriteable = yes >> /etc/samba/smb.conf
mkdir /media/pi
chmod -R 777 /media/pi
systemctl unmask hostapd
systemctl enable hostapd resolvconf
sed -i s/^exit\ 0/tail\ -n\ +25\ \\/bin\\/hotpi-ppp\ \|\ sh\\nexit\ 0/ /etc/rc.local
reboot
stty -F /dev/ttyAMA0 115200
chat '' at+cgdcont=1,'"ipv4v6"' OK at+iprex=3000000 OK > /dev/ttyAMA0 < /dev/ttyAMA0
sed -i s/tail\ -n\ +25\ \\/bin\\/hotpi-ppp\ \|\ sh/hotpi-startppp\ \;\ iptables-restore\ \<\ \\/etc\\/iptables/ /etc/rc.local
reboot
